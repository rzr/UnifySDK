<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Zigbee Protocol Controller: ZigPC Developer Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Zigbee Protocol Controller<span id="projectnumber">&#160;1.6.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_applications_zigpc_readme_developer.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ZigPC Developer Guide </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This readme is intended for Unify Framework developers, who are trying to cross compile, install, and run ZigPC on a Raspberry Pi.</p>
<h1><a class="anchor" id="autotoc_md25"></a>
Build Instructions</h1>
<p >This guide describes how to cross compile the Zigbee Protocol Controller / ZigPC for Raspberry Pi using Docker on your work station. If you haven't already built the Unify docker image, follow the guide in the docker folder readme.md file.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Set up Gecko SDK</h2>
<p >The Zigbee Protocol Controller uses certain functionality in the <a href="https://docs.silabs.com/gecko-platform/latest/">GeckoSDK</a>. The Gecko SDK can be downloaded through <a href="https://www.silabs.com/developers/simplicity-studio">Simplicity Studio</a>. The ZigPC uses the <a href="https://www.silabs.com/developers/zigbee-emberznet">EmberZNet library</a> provided through the Gecko Platform. See the [AN0822: Simplicity Studio User's Guide] (<a href="https://www.silabs.com/documents/public/application-notes/AN0822-simplicity-studio-user-guide.pdf">https://www.silabs.com/documents/public/application-notes/AN0822-simplicity-studio-user-guide.pdf</a>) for more information. In summary, select the EmberZNet library at installation time or, when creating a new project, select "Manage SDKs" followed by "Customize Installation".</p>
<p >After EmberZNet/GeckoSDK is installed, locate its path (e.g., ~/SimplicityStudio/SDKs/gecko_sdk/). Currently, v4.0 is supported. Set the environment variable $GSDK_LOCATION to this path.</p>
<h1><a class="anchor" id="autotoc_md27"></a>
Modifying Underlying SLC-based Zigbee Host Library</h1>
<p >The Zigbee Protocol Controller imports a Silicon Labs Configurator based UC project as a static library. This project should be configured in combination with any ZCL support changes performed.</p>
<p >See the Zigbee Host Library Readme for more details.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Cross Compiling for Raspberry Pi Using Docker</h2>
<blockquote class="doxtable">
<p >&zwj;Cross compilation builds currently supports only the Raspberry Pi OS Bookworm. </p>
</blockquote>
<p>From the root of the Unify source directory, run the following:</p>
<ul>
<li>Build the Docker container image:</li>
</ul>
<div class="fragment"><div class="line">cd docker</div>
<div class="line">./build_docker.sh arm64 uic_arm64</div>
<div class="line">cd ..</div>
</div><!-- fragment --><ul>
<li>Run the container with the GSDK locations mounted:</li>
</ul>
<div class="fragment"><div class="line">docker run -it --rm \</div>
<div class="line">  --env GSDK_LOCATION \</div>
<div class="line">  -v`pwd`:`pwd` \</div>
<div class="line">  -w `pwd` \</div>
<div class="line">  -v ${GSDK_LOCATION}:${GSDK_LOCATION} \</div>
<div class="line">  uic_arm64</div>
</div><!-- fragment --><p >Alternatively, use the provided runDocker.sh script in the docker directory. Fill out the GSDK_LOCATION and UIC_REPO paths in the script to properly set up the docker image.</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Compiling</h2>
<p >To compile, run these commands from the top level Unify directory, inside the Docker container:</p>
<div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake -GNinja -DCMAKE_TOOLCHAIN_FILE=../cmake/arm64_debian.cmake ..</div>
<div class="line">ninja               # Build binaries</div>
<div class="line">ninja deb           # Build Debian Installers (optional)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md30"></a>
Advanced Feature - Run Raspberry Pi Unit Tests in Docker on the Host</h2>
<p >You can run the Raspberry Pi unit tests (and ZigPC binary) within Docker on the Host machine by using QEMU to emulate the ARM architecture, and binfmt in the kernel, to tell Linux OS to run the ARM binaries within QEMU.</p>
<p >To run the unit tests within Docker on the Host machine, run the following command in the Host (not in the Docker container):</p>
<div class="fragment"><div class="line">docker run --user 0 --privileged --rm -it uic_arm64 update-binfmts --enable</div>
</div><!-- fragment --><blockquote class="doxtable">
<p >&zwj;NB: This command needs to be run once after each restart of the Host machine. </p>
</blockquote>
<p>After enabling this you can run the unittests by issuing following command in the <code>uic_arm64</code> docker image in the build directory:</p>
<div class="fragment"><div class="line">ninja test</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md31"></a>
Install Instructions</h1>
<p >For installing please refer to the general installation method in Getting started.</p>
<h1><a class="anchor" id="autotoc_md32"></a>
Reading Console Logs</h1>
<p >ZigPC is built on top of the Zigbee Host Wrapper Library. Currently this library is implemented as a Silicon Labs SLC project using the SiLabs Ember Application framework. Logs from the framework will be shown as a part of ZigPC console logs.</p>
<p >After ZigPC is launched, the logs from ZigPC will be associated with a timestamp, log level, and a tag in the following format:</p>
<p ><code>LOG_TIMESTAMP &lt;LOG_LEVEL&gt; [LOG_TAG] LOG_MESSAGE</code></p>
<p ><code>&lt;LOG_LEVEL&gt;</code> corresponds to the following:</p>
<ul>
<li><code>&lt;d&gt;</code>: Debug log</li>
<li><code>&lt;i&gt;</code>: Info log</li>
<li><code>&lt;w&gt;</code>: Warning log</li>
<li><code>&lt;e&gt;</code>: Error log</li>
<li><code>&lt;c&gt;</code>: Critical log</li>
</ul>
<p >NOTE: Any log that doesn't follow the above format is assumed to be part of printed output from the Ember Application framework.</p>
<p >The following snippet is a snippet of example logs to expect:</p>
<div class="fragment"><div class="line">zigpc --zigpc.serial /dev/ttyACM0 --mqtt.host 0.0.0.0 --mqtt.port 1883 --zigpc.datastore_file zigpc.db</div>
<div class="line"># 2020-11-05 10:55:36:314815 &lt;d&gt; [sl_log] Setting log level to debug</div>
<div class="line"># 2020-11-05 10:55:36:315475 &lt;d&gt; [uic_component_fixtures] Completed: UIC Signal Handler</div>
<div class="line"># ...</div>
<div class="line"># ...</div>
<div class="line"># 2020-11-05 10:55:36:326455 &lt;d&gt; [uic_component_fixtures] Completed: UIC STDIN</div>
<div class="line"># 2020-11-05 10:55:36:326674 &lt;d&gt; [uic_component_fixtures] Completed: ZIGPC Config</div>
<div class="line"># [linux-serial debug] emberSerialInit()</div>
<div class="line"># ...</div>
<div class="line"># ...</div>
<div class="line"># 2020-11-05 10:55:37:961488 &lt;d&gt; [zigpc_smartstart_process] SmartStart Manager Reset with new Gateway</div>
<div class="line"># 2020-11-05 10:55:37:961592 &lt;d&gt; [mqtt_client] Subscribing to: ucl/SmartStart/List</div>
<div class="line"># 2020-11-05 10:55:37:961802 &lt;d&gt; [mqtt_client] Subscription to ucl/by-unid/+/+/OnOff/+/ successful</div>
<div class="line"># 2020-11-05 10:55:37:961979 &lt;d&gt; [mqtt_client] Subscription to ucl/SmartStart/List successful</div>
<div class="line"># ZigPC&gt;</div>
</div><!-- fragment --><p >The <code>ZigPC&gt;</code> prompt can be used to carry out common Protocol Controller functions. Typing "help" brings up the currently supported functions:</p>
<div class="fragment"><div class="line">ZigPC&gt; help</div>
<div class="line">==================================================</div>
<div class="line">Unify Command line interface Help:</div>
<div class="line">==================================================</div>
<div class="line">exit  :Exit the application</div>
<div class="line">help  :Prints help</div>
<div class="line">info  :Execute &#39;info&#39; command accessible from the EmberAf CLI</div>
<div class="line">log_level d|i||w|e|c:Set log levelDEBUG | INFO | WARNING | ERROR | CRITICAL</div>
<div class="line">==================================================</div>
<div class="line">Tip: log_level c to reduce the verbosity of log</div>
<div class="line">==================================================</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md33"></a>
Changing Log Levels</h2>
<p >Changing the log levels can be achieved using the log_level command in the "ZigPC&gt;" console on ZigPC. The following formats are supported for this command:</p>
<ul>
<li><code>log_level &lt;level&gt;</code></li>
<li><code>log_level &lt;tag&gt;,&lt;level&gt;</code></li>
</ul>
<p ><code>&lt;tag&gt;</code> corresponds to any of the tags you see in the logs (i.e., <a class="el" href="structmqtt__client.html">mqtt_client</a>)</p>
<p ><code>&lt;level&gt;</code> corresponds to any one of the following (can be applied overall or to a particular log_tag):</p>
<ul>
<li>"off": turn off logs</li>
<li>"d": Show logs up to debug levels (critical, errors, warnings, info, debug)</li>
<li>"i": Show logs up to info levels (critical, errors, warnings, info)</li>
<li>"w": Show logs up to warning levels (critical, errors, warnings)</li>
<li>"e": Show logs up to error levels (critical, errors)</li>
<li>"c": Show logs up to critical levels (critical</li>
</ul>
<p ><br  />
<br  />
</p>
<h1><a class="anchor" id="autotoc_md34"></a>
Using Zigbee Network Analyzer to Monitor PAN</h1>
<p >The "Network Analyzer" perspective in Silicon Labs <a href="https://www.silabs.com/developers/simplicity-studio">Simplicity Studio</a> IDE v5 can be used to analyze the traffic on the Zigbee PAN.</p>
<p >Network activity can be observed based on the UCL commands relayed by ZigPC.</p>
<h2><a class="anchor" id="autotoc_md35"></a>
Installing Simplicity Studio v5</h2>
<p >If you have not done so already, download Simplicity Studio v5 from <a href="https://www.silabs.com/products/development-tools/software/simplicity-studio">https://www.silabs.com/products/development-tools/software/simplicity-studio</a> on a host computer.</p>
<h2><a class="anchor" id="autotoc_md36"></a>
Detecting Devices in Simplicity Studio</h2>
<p >Devices in <a href="https://www.silabs.com/developers/simplicity-studio">Simplicity Studio</a> can be detected using any of the following methods:</p>
<h3><a class="anchor" id="autotoc_md37"></a>
Connection via Ethernet Interface</h3>
<p >If the host computer and one of the Zigbee devices are connected via Ethernet (using a Wireless Starter Kit for example: <a href="https://www.silabs.com/development-tools/wireless/efr32xg22-wireless-starter-kit">https://www.silabs.com/development-tools/wireless/efr32xg22-wireless-starter-kit</a>), <a href="https://www.silabs.com/developers/simplicity-studio">Simplicity Studio</a> can capture network traffic using this interface. Either an end device or the gateway radio can be connected via Ethernet to perform network capture (since the serial USB connection, which ZigPC uses, can run independently of the Ethernet connection services).</p>
<p >Instructions:</p>
<ol type="1">
<li>Ensure that the radio is assigned an IP address (static or dynamic).</li>
<li>In Studio, navigate from the top menu: Window → Preferences.</li>
<li>In the preferences window, go to the left menu and select: Simplicity Studio → Device Manager → TCP/IP Adapters.</li>
<li>In the TCP/IP Adapters view, add your device's IP Address in the Discovery Subnet Configuration section.</li>
<li>Click on "Apply" and then "OK".</li>
<li>Devices will now appear in the "Debug Adapters" view.</li>
<li>If the device doesn't appear, click on the "Refresh" icon in the "Debug
   Adapters" view.</li>
</ol>
<h3><a class="anchor" id="autotoc_md38"></a>
Connection via Serial USB Interface</h3>
<p >Because the Gateway radio is connected to Raspberry Pi running ZigPC, a test end device should be connected to the host computer.</p>
<p >Instructions:</p>
<ol type="1">
<li>Plug in the end device to the host computer.</li>
<li>Devices will now appear in the "Debug Adapters" view.</li>
<li>If the device doesn't appear, click on the "Refresh" icon in the "Debug
   Adapters" view.</li>
</ol>
<h2><a class="anchor" id="autotoc_md39"></a>
Capturing Network Traffic in Simplicity Studio</h2>
<p >Using the top menu, select Window → Perspective → Network Analyzer.</p>
<p >Then, in the "Debug Adapters" window, right-click on the connected device and click "Connect", then click "Start capture".</p>
<p >This will trigger the Network Analyzer to record PAN events, as shown below:</p>
<p ><img src="doc/assets/user_guide-network-analyzer-view.png" alt="" class="inline"/></p>
<p >The middle table, labeled "Transactions", can be used to get a high-level overview of messages sent on the network.</p>
<h2><a class="anchor" id="autotoc_md40"></a>
Decrypting Network Traffic in Simplicity Studio</h2>
<p >ZigPC uses Network key (NWK key) based on the install code. In typical Zigbee applications, the Ember CLI can be used to get this key. The CLI can be re-enabled at compilation time, however, the network information is also printed out at startup.</p>
<p >Look for the following pattern:</p>
<div class="fragment"><div class="line">[DEBUG] NWK Key:: ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ ZZ</div>
</div><!-- fragment --><p >Extract the NWK key value ( <code>ZZ ZZ ZZ ...</code> sequence in the log above) and add it as a Network Analyzer Security Key using the following instructions:</p>
<ol type="1">
<li>Open <a href="https://www.silabs.com/developers/simplicity-studio">Simplicity Studio</a> v5.</li>
<li>Click from the top menu: Window -&gt; Preferences.</li>
<li>From the left sidebar, select: Network Analyzer -&gt; Decoding -&gt; Security Keys.</li>
<li>Add a New Entry and insert the NWK key as the Key value.</li>
<li>Click Apply then OK.</li>
</ol>
<p >This NWK key can now decrypt network traffic after the node has joined the network.</p>
<p >For more information, see <a href="https://www.silabs.com/documents/public/quick-start-guides/qsg106-efr32-zigbee-pro.pdf">"Section 6: Using the Network Analyzer" in QSG106: Zigbee EmberZNet PRO Quick-Start Guide</a>.</p>
<p >For example, the following decrypted transactions are seen when the SmartStart addition is performed to add an end device to the PAN using the Install Code based DSK:</p>
<p ><img src="doc/assets/user_guide-network-analyzer-node-add.png" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md41"></a>
Adding custom clusters</h2>
<p >It is possible to add custom ZCL info to ZigPC to add natively unsupported clusters or to override the functionality of default clusters. This step must be run at compilation time in order to properly include the necessary MQTT topics and other related ZCL information.</p>
<ul>
<li>Step 1: Adding the custom cluster to the Unify framework</li>
</ul>
<p >Add a custom XML file (or modify an existing XML file) in the shared components of the Unify framework. All XML files defining ZCL clusters are stored in the 'uic-dotdot' component under the 'dotdot-xml' folder. If a new XML file is added or if the name of an XML file changes, that change must be reflected in the library.xml file</p>
<ul>
<li>Step 2: Adding the custom cluster in the ZigPC</li>
</ul>
<p >ZigPC generates ZCL-cluster code and structures using ZAP. Ensure that the ZAP templates will generate for the new cluster by adding the name to: 'uic/applications/zigpc/components/zcl_util/zap/addon-helper.js Specifically, the 'SUPPORTED_CLUSTERS' and 'SUPPORTED_CLUSTER_ATTRIBUTES' lists must reference the new cluster.</p>
<ul>
<li>Step 3: Adding the custom clusters in the zigbeeHost gateway level</li>
</ul>
<p >ZigPC uses a custom zigbeeHost layer to manage the zigbee stack. Ensure that this layer can also access the new ZCL cluster by modifying the slcp file in 'uic/applications/zigpc/components/zigpc_gateway/libs/zigbee_host/src/libzigbee_host.slcp' Add the new cluster in the same format as all the existing clusters at this layer.</p>
<p >*Step 4: Re-generate all ZAP templates</p>
<p >Unify uses ZAP to generate ZCL cluster information (as discussed in step #2). Make sure that zap can find the library by modifying its configuration file.</p>
<p >Alternatively, compile with the cmake option 'ZAP_GENERATE' set to 'ON' to automatically re-generate zap output files as part of the compilation process.</p>
<p >Re-generate all zap output in the top level uic for the following components: uic_dotdot, <a class="el" href="namespaceuic__dotdot__mqtt.html">uic_dotdot_mqtt</a>, unify_dotdot_attribute_store</p>
<p >Re-generate all zap output in the zigpc level for the following components: command_mapper, zcl_util, zcl_command_parser, zcl_profiles, attribute_management</p>
<p >Please take a look at [<a href="https://github.com/SiliconLabs/zap">https://github.com/SiliconLabs/zap</a>] for more detailed information.</p>
<ul>
<li>Step 5: Re-generate the zigbee_host</li>
</ul>
<p >Re-generate the zigbee_host slcp, in the autogen folder. Set the STUDIO_ADAPTER_PATH to point to zap, which should already be configured to point to the custom xml. Otherwise, it will be necessary to edit the zap-config of the zigbee_host folder.</p>
<p >Please read [<a href="https://siliconlabs.github.io/slc-specification/1.0/">https://siliconlabs.github.io/slc-specification/1.0/</a>] and [<a href="https://www.silabs.com/documents/public/user-guides/ug520-software-project-generation-configuration-with-slc-cli.pdf">https://www.silabs.com/documents/public/user-guides/ug520-software-project-generation-configuration-with-slc-cli.pdf</a>] for more information on using the slc_cli.</p>
<ul>
<li>Step 6:</li>
</ul>
<p >Compile ZigPC as normal. ZigPC should now support your custom cluster </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Aug 7 2024 15:21:44 for Zigbee Protocol Controller by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
