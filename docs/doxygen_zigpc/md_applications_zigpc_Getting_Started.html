<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Zigbee Protocol Controller: Table Of Contents</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Zigbee Protocol Controller<span id="projectnumber">&#160;1.6.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_applications_zigpc_Getting_Started.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Table Of Contents </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>Table Of Contents</li>
<li>Preparing Hardware</li>
<li>Preparing the OS and installing required tools</li>
<li>Getting the source code on the devices</li>
<li>Docker Setup</li>
<li>Raspberry Pi Setup</li>
<li>Compiling code for the Raspberry Pi</li>
<li>Getting the NCP WSTK going :</li>
<li>Debugging with visual studio code, Cleaning the code </li>
</ul>
<h1><a class="anchor" id="autotoc_md13"></a>
Preparing Hardware</h1>
<p >For this guide you need :</p>
<ul>
<li>2 WSTK with BRD4163A radios</li>
<li>1 Raspberry Pi (3B+ or 4)</li>
<li>1 Network switch </li>
</ul>
<h1><a class="anchor" id="autotoc_md14"></a>
Preparing the OS and installing required tools</h1>
<p >Easy to install tools :</p>
<ul>
<li>Git</li>
<li>Visual Studio Code</li>
<li>Raspberry Pi Imager : <a href="https://www.raspberrypi.com/software/">https://www.raspberrypi.com/software/</a></li>
<li>Simplicity Studio 5 : <a href="https://www.silabs.com/developers/simplicity-studio">https://www.silabs.com/developers/simplicity-studio</a></li>
<li>Docker : <a href="https://www.docker.com/">https://www.docker.com/</a></li>
<li>GDB - might require specific steps for macos : see <a href="https://gist.github.com/gravitylow/fb595186ce6068537a6e9da6d8b5b96d">https://gist.github.com/gravitylow/fb595186ce6068537a6e9da6d8b5b96d</a> to sign gdb</li>
<li>MQTT Explorer : https://mqtt-explorer.com/</li>
<li>Nice to have : FileZila VNC Viewer </li>
</ul>
<h1><a class="anchor" id="autotoc_md15"></a>
Getting the source code on the devices</h1>
<p >Clone the unify git repo :</p>
<p >    <code>git clone <a href="https://github.com/SiliconLabs/UnifySDK.git">https://github.com/SiliconLabs/UnifySDK.git</a></code></p>
<p >Initialise the git submodules of the repo : <code>git submodule update --init --recursive</code></p>
<p >Get a copy of the GSDK</p>
<p ><a href="https://github.com/SiliconLabs/gecko_sdk">github.com/SiliconLabs/gecko_sdk</a></p>
<p >public repo : </p>
<p >    <code>git clone <a href="https://github.com/SiliconLabs/gecko_sdk">https://github.com/SiliconLabs/gecko_sdk</a></code></p>
<p >You need to add the GSDK location to your environment variable GSDK_LOCATION</p>
<p >See also : Specific build instruction /projects/UIC/repos/uic/browse/doc/build_instructions.internal.md</p>
<h1><a class="anchor" id="autotoc_md16"></a>
Docker Setup</h1>
<p >After having installed docker desktop</p>
<p >To build and cross compile stuff ( inside host shell )</p>
<p >From the uic repository /docker folder : To create new container for specific architectures : <code>./build_docker.sh &lt;architecture&gt; &lt;container_name&gt;</code> EX : For the Pi     <code>./build_docker.sh arm64 uic_arm64</code> Ex : To run unit test      <code>./build_docker.sh amd64 uic_amd64</code></p>
<p >Once the docker script is done : From the uic root folder run :</p>
<div class="fragment"><div class="line">docker run -it --rm \</div>
<div class="line">  --env GSDK_LOCATION \</div>
<div class="line">  -v`pwd`:`pwd` \</div>
<div class="line">  -w `pwd` \</div>
<div class="line">  -v ${GSDK_LOCATION}:${GSDK_LOCATION} \</div>
<div class="line">  uic_arm64</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md17"></a>
Raspberry Pi Setup</h1>
<p >Using the Raspberry Pi Imager, select the latest 64 bit Rasbian OS. In advanced options of the Imager (Click the gear icon after selecting the OS), enable ssh, set username and password, hostname, enable wifi.</p>
<p >Add mosquitto to the system: </p><div class="fragment"><div class="line">$sudo apt update</div>
<div class="line">$sudo apt install mosquitto mosquitto-clients`</div>
</div><!-- fragment --><p> Install the packages from latest release :</p>
<p >Get the latest packages from the develop branch :</p>
<p ><a href="https://github.com/SiliconLabs/UnifySDK/releases">https://github.com/SiliconLabs/UnifySDK/releases</a></p>
<p >Install them using (change name as required ) :</p>
<div class="fragment"><div class="line">sudo dpkg -i uic-dev-gui_*_arm64.deb uic-gms_*_arm64.deb uic-image-provider_*_arm64.deb uic-upvl_*_arm64.deb uic-zigpc_*_arm64.deb</div>
</div><!-- fragment --><p >See user guide for more info : /projects/UIC/repos/uic/browse/doc/readme_user.md</p>
<p >For future MQTT Explorer use, add those lines to /etc/mosquitto/mosquitto.conf</p>
<div class="fragment"><div class="line">listener 1883</div>
<div class="line">allow_anonymous true</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md18"></a>
Compiling code for the Raspberry Pi</h1>
<p >On the development computer :</p>
<p >Go back to uic folder and enter your docker container using the previous docker run command (See Docker Setup). Set up the cmake build folder using : </p><div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake -GNinja -DCMAKE_TOOLCHAIN_FILE=../cmake/arm64_debian.cmake -DBUILD_ZPC=OFF -DCMAKE_BUILD_TYPE=Debug ..</div>
<div class="line">ninja               # Build binaries</div>
<div class="line">ninja doxygen       # Build doxygen documentation (optional)</div>
<div class="line">ninja deb           # Build Debian Installers (optional)</div>
</div><!-- fragment --><p> Notice that this is telling cmake to use the specific target architecture ( arm64 ) toolchain and to enable debug symbol for future debugging.</p>
<p >If you want to reduce build time, you can specifically build a specific component :</p>
<div class="fragment"><div class="line">ninja zigpc #Builds zigpc application</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md19"></a>
Getting the NCP WSTK going</h1>
<p >Since <a href="https://www.silabs.com/developers/simplicity-studio">Simplicity Studio</a> adds time to this process, we will try to skip its usage. Be aware that you can generate new firmware with specific cluster using <a href="https://www.silabs.com/developers/simplicity-studio">Simplicity Studio</a> or by modifying the slcp file and then generating using the slc tool.</p>
<p >Thus, we will use the slc command line tool to create the firmware for the ncp.</p>
<p >Related user guide : <a href="https://www.silabs.com/documents/public/user-guides/ug520-software-project-generation-configuration-with-slc-cli.pdf">https://www.silabs.com/documents/public/user-guides/ug520-software-project-generation-configuration-with-slc-cli.pdf</a></p>
<p >Follow the user guide installation process in order to install the tool, then add the slc folder to your system environment path.</p>
<p >You can find Zigbee sample apps for the ncp in the Gecko SDK folder under gecko-sdk/protocol/zigbee/app/ncp/sample-app/ncp-uart-hw</p>
<p >The Boatloader is under gecko-sdk/platform/bootloader/sample-apps/bootloader-storage-spiflash</p>
<p >In order to get the .s37 executable for the boatloader and the zigbee application :</p>
<div class="fragment"><div class="line">slc generate ncp-uart-hw.slcp --with &lt;BOARD_IDENTIFIER&gt; -np -d output/cd output</div>
<div class="line">make -f ncp-uart-hw.Makefile</div>
</div><!-- fragment --><p >Example board identifier Thunderboard sense 2 : brd4166a </p><blockquote class="doxtable">
<p >&zwj;Note : To synchronise the device and the gateway address table. add under define in the &lt;NCP-NAME&gt;.slcp </p>
</blockquote>
<div class="fragment"><div class="line">- name: &quot;EMBER_ADDRESS_TABLE_SIZE&quot;</div>
<div class="line">  value: &quot;32&quot;</div>
</div><!-- fragment --><p> This value must match EMBER_AF_PLUGIN_ADDRESS_TABLE_SIZE in zigpc/components/zigpc_gateway/libs/zigbee_host/gen/config</p>
<p >Once you have both .s37 files, flash using simplicity commander / <a href="https://www.silabs.com/developers/simplicity-studio">Simplicity Studio</a></p>
<h2><a class="anchor" id="autotoc_md20"></a>
Troubleshooting NCP issues and versioning</h2>
<p >There are some common issues faced when updating to a new version of ZigPC or a new version of the GeckoSDK</p>
<h3><a class="anchor" id="autotoc_md21"></a>
Issue #1: NCP and Gateway mismatch</h3>
<p >After upgrading, it is possible to see ZigPC fail to start with the error:</p>
<blockquote class="doxtable">
<p >&zwj; ERROR: ezspErrorHandler 0x30 </p>
</blockquote>
<p>Or an equivalent error.</p>
<p >Usually this occurs because the version of the GeckoSDK on the gateway and the version on the NCP do not match. It's important that version matches so that the EZSP communication libraries are the same on both the host and the radio.</p>
<p >This issue can be resolved in 2 ways: downgrading the version of the GeckoSDK to match with the NCP or updating the NCP firmware to match the gateway.</p>
<p >To change the version of the GeckoSDK used by the gateway, download the desired version of the GeckoSDK and keep note of the directory it is stored in. By default, the provided Docker container downloads the latest version to the 'externals' folder in the uic project. This can be overridden by setting the "GSDK\_LOCATION" environment variable with the new GeckoSDK and re-compiling the ZigPC gateway.</p>
<p >To update the NCP firmware, re-generate the firmware as described above with the matching version of the GeckoSDK. If you have hardware access, re-flash the NCP as usual. However, if only remote access is possible, ZigPC can be used to update the NCP firmware as described in the User Guide (section 'Updating NCP Firmware'</p>
<h3><a class="anchor" id="autotoc_md22"></a>
Issue #2: addressTable mismatch</h3>
<p >When running the ZigPC, its possible for the gateway to fail to start with an error describing:</p>
<blockquote class="doxtable">
<p >&zwj;ASSERT addressTableSize mismatch </p>
</blockquote>
<p>or a similar error.</p>
<p >Usually, this occurs because the address table size was not properly set in the NCP. Some information is shared between the gateway and the NCP, specifically related to the network information. In this case, the address table is used to resolve the global EUI64 with the short ID commonly used on zigbee networks. The size of these tables should match on both the gateway and NCP to ensure that no data is lost when handling too many devices.</p>
<p >There are two ways of solving this: reducing the address table on the gateway or increasing the address table size on the NCP.</p>
<p >The recommended method is to increase the address table size on the NCP. This can be done by adding the "EMBER\_ADDRESS\_TABLE\_SIZE" to the .slcp file, as described in the section above. Alternatively, add a definition to the NCP makefile setting the above define. Compiling with -DEMBER_ADDRESS_TABLE_SIZE= 32 will also work.</p>
<p >It is possible to solve this by reducing EMBER_AF_ADDRESS_TABLE_SIZE on the gateway, however this is NOT recommended as it can reduce the number of devices that ZigPC will support</p>
<h1><a class="anchor" id="autotoc_md23"></a>
Debugging with visual studio code, Cleaning the code</h1>
<p >From phase 6 you should now have the ability to generate custom zigpc executables.</p>
<p >Transfer them to the pi using FileZila or scp.</p>
<p >make sure that no uic-zigpc from previously installed package are running using (use killall if need be) </p><div class="fragment"><div class="line">sudo systemctl status uic-zigpc</div>
<div class="line">chmod +x ./zigpc</div>
<div class="line">sudo ./zigpc</div>
</div><!-- fragment --><p> &gt;Note : zigpc should not usually be runned as superuser. There is currently a bug in datastore that forces this issue.</p>
<p >You should now be able to access the devgui of the gateway under raspberrypi.local:3080</p>
<p >For more information about the devgui see : /projects/UIC/repos/uic/browse/applications/dev_ui/dev_gui/readme_user.md</p>
<p >Debugging using visual studio code : Install native debug extension : <a href="https://marketplace.visualstudio.com/items?itemName=webfreak.debug">https://marketplace.visualstudio.com/items?itemName=webfreak.debug</a></p>
<p >Create a code workspace containing both the Gecko SDK folder and the UIC folder</p>
<p >As the Launch.json use :</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;configurations&quot;: [</div>
<div class="line">    {</div>
<div class="line">        &quot;type&quot;: &quot;gdb&quot;,</div>
<div class="line">        &quot;request&quot;: &quot;attach&quot;,</div>
<div class="line">        &quot;name&quot;: &quot;Extended remote raspberrypi&quot;,</div>
<div class="line">        &quot;executable&quot;: &quot;PATH_TO_UIC/uic/build/applications/zigpc/zigpc&quot;,</div>
<div class="line">        &quot;target&quot;: &quot;extended-remote raspberrypi.local:2000&quot;,</div>
<div class="line">        &quot;remote&quot;: false,</div>
<div class="line">        &quot;cwd&quot;: &quot;${workspaceRoot}&quot;,</div>
<div class="line">        &quot;valuesFormatting&quot;: &quot;parseText&quot;,</div>
<div class="line">        &quot;stopAtConnect&quot;: true</div>
<div class="line">    }</div>
<div class="line">    ]</div>
<div class="line">}</div>
</div><!-- fragment --><p >On the Pi install gdbserver </p><div class="fragment"><div class="line">sudo apt-get install gdbserver</div>
<div class="line">#Run ZigPc on GDBserver</div>
<div class="line">sudo gdbserver localhost:2000 ./zigpc</div>
</div><!-- fragment --><p> Cleaning the code : To clang format in zigpc (Modify path as needed) </p><div class="fragment"><div class="line">find ../applications/zigpc/components -iname &quot;*.c&quot; -o -iname &quot;*.h&quot; -o -iname &quot;*.cpp&quot;  | xargs clang-format-10 -i</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Aug 7 2024 15:21:44 for Zigbee Protocol Controller by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
